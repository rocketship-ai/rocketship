# Minikube local development values
# This configuration enables all services needed for full e2e testing:
# - Engine + Worker
# - Controlplane (GitHub OAuth device flow)
# - Postgres (user/org storage)
#
# Secrets are created by the setup-local-dev.sh script.
# For local development, GitHub OAuth is configured but can use test credentials.

auth:
  mode: oidc
  oidc:
    mode: github
    # Use ingress hostname that works both inside and outside the cluster
    # Requires: minikube tunnel + /etc/hosts entry for auth.minikube.local
    issuer: http://auth.minikube.local
    clientID: rocketship-cli
    audience: rocketship-cli
    deviceEndpoint: http://auth.minikube.local/device/code
    tokenEndpoint: http://auth.minikube.local/token
    jwksURL: http://auth.minikube.local/.well-known/jwks.json
    scopes:
      - read:org
      - read:user
      - user:email

# Controlplane (Cloud API) configuration
controlplane:
  enabled: true
  issuer: http://auth.minikube.local
  audience: rocketship-cli
  clientID: rocketship-cli
  scopes:
    - read:org
    - read:user
    - user:email
  github:
    # GitHub OAuth App credentials come from the rocketship-github-oauth secret
    # Created by setup-local-dev.sh from .env values:
    #   ROCKETSHIP_GITHUB_CLIENT_ID
    #   ROCKETSHIP_GITHUB_CLIENT_SECRET
    # Create your own OAuth App at https://github.com/settings/developers
    # IMPORTANT: Enable "Device Flow" in the OAuth App settings
    # Set callback URL to: http://auth.minikube.local/callback
    # NOTE: OAuth is identity-only; repo access uses GitHub App installation
    clientSecretSecret: rocketship-github-oauth
    clientSecretKey: ROCKETSHIP_GITHUB_CLIENT_SECRET
    scopes:
      - read:org
      - read:user
      - user:email
  signingKey:
    secretName: rocketship-controlplane-signing
    key: signing-key.pem
    mountPath: /var/run/rocketship
    fileName: signing-key.pem
  database:
    secretName: rocketship-controlplane-database
    secretKey: DATABASE_URL
  refreshTokenKey:
    secretName: rocketship-controlplane-secrets
    secretKey: ROCKETSHIP_CONTROLPLANE_REFRESH_KEY
  env:
    - name: ROCKETSHIP_CONTROLPLANE_ACCESS_TTL
      value: 15m
    - name: ROCKETSHIP_CONTROLPLANE_REFRESH_TTL
      value: 720h
  service:
    type: ClusterIP
    port: 8080
  ingress:
    enabled: false  # Using gateway ingress instead
  envFrom:
    - secretRef:
        name: rocketship-github-oauth
    - secretRef:
        name: rocketship-postmark-secret
    - secretRef:
        name: rocketship-github-app
    - secretRef:
        name: rocketship-github-webhook
        optional: true
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# Enable bundled Postgres for local development
postgres:
  enabled: true

# Use the Bitnami Postgres subchart
postgresql:
  auth:
    existingSecret: rocketship-postgres-auth
    existingSecretPasswordKey: password
    existingSecretPostgresPasswordKey: postgres-password
    username: rocketship
    database: rocketship
  primary:
    persistence:
      enabled: true
      size: 2Gi
  image:
    registry: docker.io
    repository: bitnamilegacy/postgresql
    tag: 16.3.0-debian-12-r23

engine:
  service:
    type: ClusterIP
  database:
    secretName: rocketship-controlplane-database
    secretKey: DATABASE_URL
  env:
    - name: ROCKETSHIP_DISABLE_GRPC_WEB
      value: "false"  # Enable gRPC-Web for browser access through ingress
  # For minikube: point auth.minikube.local to ingress-nginx-controller ClusterIP
  # NOTE: This IP is overridden dynamically by Skaffold using ROCKETSHIP_INGRESS_IP
  # (detected by start-dev.sh). The placeholder below is never used when running via Skaffold.
  hostAliases:
    - ip: "PLACEHOLDER_OVERRIDDEN_BY_SKAFFOLD"
      hostnames:
        - "auth.minikube.local"
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

worker:
  replicaCount: 1
  # Engine address for log forwarding (in-cluster)
  engineAddress: "rocketship-engine:7700"
  # Service account token secret for worker -> engine auth
  tokenSecret:
    secretName: rocketship-worker-token
    secretKey: token
  resources:
    requests:
      memory: "512Mi"
      cpu: "200m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

# Gateway ingress - UI and auth endpoints (no rewrite)
gateway:
  enabled: true
  className: nginx
  hosts:
    - host: auth.minikube.local
      paths:
        # Controlplane endpoints
        - path: /.well-known
          pathType: Prefix
          serviceName: rocketship-controlplane
          port: 8080
        - path: /api
          pathType: Prefix
          serviceName: rocketship-controlplane
          port: 8080
        - path: /authorize
          pathType: Prefix
          serviceName: rocketship-controlplane
          port: 8080
        - path: /token
          pathType: Prefix
          serviceName: rocketship-controlplane
          port: 8080
        - path: /callback
          pathType: Prefix
          serviceName: rocketship-controlplane
          port: 8080
        - path: /logout
          pathType: Prefix
          serviceName: rocketship-controlplane
          port: 8080
        - path: /device
          pathType: Prefix
          serviceName: rocketship-controlplane
          port: 8080
        - path: /github-app
          pathType: Prefix
          serviceName: rocketship-controlplane
          port: 8080
        # Vite dev server (catch-all for web UI)
        - path: /
          pathType: Prefix
          serviceName: vite-relay
          port: 5173

# Engine ingress - separate to enable path rewrite for gRPC-Web
engineIngress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: "/$2"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
  hosts:
    - host: auth.minikube.local
      paths:
        - path: /engine(/|$)(.*)
          pathType: ImplementationSpecific
          serviceName: rocketship-engine
          port: 7700

# GitHub webhook relay (smee.io -> controlplane)
# Enabled for local development; secret must be created by setup-local-dev.sh
githubWebhookRelay:
  enabled: true
  secretName: rocketship-github-webhook
