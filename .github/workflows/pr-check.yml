name: Pull Request Check

on:
  pull_request:
    branches: ["main"]
    paths:
      - "**.go"
      - "go.mod"
      - "go.sum"
      - ".github/workflows/**"
      - ".docker/**"
      - "examples/**"
      - "internal/dsl/schema.json"

jobs:
  test-build:
    name: Test Multi-Platform Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          check-latest: true

      - name: Run tests
        run: go test ./...

      - name: Test build for all platforms
        run: |
          # Create test build directory
          mkdir -p test-build

          # Test CLI builds
          GOOS=darwin GOARCH=amd64 go build -o test-build/rocketship-darwin-amd64 cmd/rocketship/main.go
          GOOS=darwin GOARCH=arm64 go build -o test-build/rocketship-darwin-arm64 cmd/rocketship/main.go
          GOOS=linux GOARCH=amd64 go build -o test-build/rocketship-linux-amd64 cmd/rocketship/main.go
          GOOS=linux GOARCH=arm64 go build -o test-build/rocketship-linux-arm64 cmd/rocketship/main.go
          GOOS=windows GOARCH=amd64 go build -o test-build/rocketship-windows-amd64.exe cmd/rocketship/main.go

          # Test worker builds
          GOOS=darwin GOARCH=amd64 go build -o test-build/worker-darwin-amd64 cmd/worker/main.go
          GOOS=darwin GOARCH=arm64 go build -o test-build/worker-darwin-arm64 cmd/worker/main.go
          GOOS=linux GOARCH=amd64 go build -o test-build/worker-linux-amd64 cmd/worker/main.go
          GOOS=linux GOARCH=arm64 go build -o test-build/worker-linux-arm64 cmd/worker/main.go
          GOOS=windows GOARCH=amd64 go build -o test-build/worker-windows-amd64.exe cmd/worker/main.go

          # Test engine builds
          GOOS=darwin GOARCH=amd64 go build -o test-build/engine-darwin-amd64 cmd/engine/main.go
          GOOS=darwin GOARCH=arm64 go build -o test-build/engine-darwin-arm64 cmd/engine/main.go
          GOOS=linux GOARCH=amd64 go build -o test-build/engine-linux-amd64 cmd/engine/main.go
          GOOS=linux GOARCH=arm64 go build -o test-build/engine-linux-arm64 cmd/engine/main.go
          GOOS=windows GOARCH=amd64 go build -o test-build/engine-windows-amd64.exe cmd/engine/main.go

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test Docker builds
        run: |
          # Test CLI image build
          docker build -f .docker/ci-testing/Dockerfile.cli -t rocketshipai/rocketship:test .

          # Test Engine image build
          docker build -f .docker/Dockerfile.engine -t rocketshipai/rocketship-engine:test .

          # Test Worker image build
          docker build -f .docker/Dockerfile.worker -t rocketshipai/rocketship-worker:test .

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          check-latest: true

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest

  cli-integration:
    name: CLI Integration Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: testdb
          MYSQL_USER: testuser
          MYSQL_PASSWORD: testpass
          MYSQL_ROOT_PASSWORD: testpass
        ports:
          - 3307:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          check-latest: true

      - name: Wait for databases and initialize
        run: |
          echo "Waiting for databases to be ready..."
          
          # Wait for PostgreSQL to be ready
          echo "Waiting for PostgreSQL..."
          for i in {1..30}; do
            if PGPASSWORD=testpass psql -h localhost -p 5433 -U testuser -d testdb -c "SELECT 1" > /dev/null 2>&1; then
              echo "✅ PostgreSQL is ready!"
              break
            fi
            echo "PostgreSQL not ready, waiting... ($i/30)"
            sleep 2
          done
          
          # Wait for MySQL to be ready
          echo "Waiting for MySQL..."
          for i in {1..30}; do
            if mysql -h localhost -P 3307 -u testuser -ptestpass testdb -e "SELECT 1" > /dev/null 2>&1; then
              echo "✅ MySQL is ready!"
              break
            fi
            echo "MySQL not ready, waiting... ($i/30)"
            sleep 2
          done
          
          echo "Setting up PostgreSQL schema..."
          PGPASSWORD=testpass psql -h localhost -p 5433 -U testuser -d testdb << 'EOF'
          -- Users table
          CREATE TABLE IF NOT EXISTS users (
              id SERIAL PRIMARY KEY,
              name VARCHAR(255) NOT NULL,
              email VARCHAR(255) UNIQUE NOT NULL,
              age INTEGER,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );

          -- Products table
          CREATE TABLE IF NOT EXISTS products (
              id SERIAL PRIMARY KEY,
              name VARCHAR(255) NOT NULL,
              category VARCHAR(100),
              price DECIMAL(10, 2) NOT NULL,
              description TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );

          -- Orders table
          CREATE TABLE IF NOT EXISTS orders (
              id SERIAL PRIMARY KEY,
              user_id INTEGER REFERENCES users(id),
              product_id INTEGER REFERENCES products(id),
              quantity INTEGER NOT NULL DEFAULT 1,
              total_amount DECIMAL(10, 2) NOT NULL,
              status VARCHAR(50) DEFAULT 'pending',
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );

          -- Insert sample data
          INSERT INTO users (name, email, age) VALUES 
              ('Alice Johnson', 'alice@example.com', 28),
              ('Bob Smith', 'bob@example.com', 34),
              ('Carol Davis', 'carol@example.com', 22),
              ('David Wilson', 'david@example.com', 41);

          INSERT INTO products (name, category, price, description) VALUES 
              ('Laptop Pro', 'Electronics', 1299.99, 'High-performance laptop'),
              ('Smartphone X', 'Electronics', 899.99, 'Latest smartphone model'),
              ('Office Chair', 'Furniture', 299.99, 'Ergonomic office chair'),
              ('Desk Lamp', 'Furniture', 79.99, 'LED desk lamp'),
              ('Wireless Mouse', 'Electronics', 49.99, 'Bluetooth wireless mouse');

          INSERT INTO orders (user_id, product_id, quantity, total_amount, status) VALUES 
              (1, 1, 1, 1299.99, 'completed'),
              (1, 5, 2, 99.98, 'completed'),
              (2, 2, 1, 899.99, 'pending'),
              (3, 3, 1, 299.99, 'processing'),
              (4, 4, 1, 79.99, 'completed');
          EOF

          echo "Setting up MySQL schema..."
          mysql -h localhost -P 3307 -u testuser -ptestpass testdb << 'EOF'
          -- Users table
          CREATE TABLE IF NOT EXISTS users (
              id INT PRIMARY KEY AUTO_INCREMENT,
              name VARCHAR(255) NOT NULL,
              email VARCHAR(255) UNIQUE NOT NULL,
              age INT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
          );

          -- Products table
          CREATE TABLE IF NOT EXISTS products (
              id INT PRIMARY KEY AUTO_INCREMENT,
              name VARCHAR(255) NOT NULL,
              category VARCHAR(100),
              price DECIMAL(10, 2) NOT NULL,
              description TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );

          -- Orders table
          CREATE TABLE IF NOT EXISTS orders (
              id INT PRIMARY KEY AUTO_INCREMENT,
              user_id INT,
              product_id INT,
              quantity INT NOT NULL DEFAULT 1,
              total_amount DECIMAL(10, 2) NOT NULL,
              status VARCHAR(50) DEFAULT 'pending',
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              FOREIGN KEY (user_id) REFERENCES users(id),
              FOREIGN KEY (product_id) REFERENCES products(id)
          );

          -- Insert sample data
          INSERT INTO users (name, email, age) VALUES 
              ('Alice Johnson', 'alice@example.com', 28),
              ('Bob Smith', 'bob@example.com', 34),
              ('Carol Davis', 'carol@example.com', 22),
              ('David Wilson', 'david@example.com', 41);

          INSERT INTO products (name, category, price, description) VALUES 
              ('Laptop Pro', 'Electronics', 1299.99, 'High-performance laptop'),
              ('Smartphone X', 'Electronics', 899.99, 'Latest smartphone model'),
              ('Office Chair', 'Furniture', 299.99, 'Ergonomic office chair'),
              ('Desk Lamp', 'Furniture', 79.99, 'LED desk lamp'),
              ('Wireless Mouse', 'Electronics', 49.99, 'Bluetooth wireless mouse');

          INSERT INTO orders (user_id, product_id, quantity, total_amount, status) VALUES 
              (1, 1, 1, 1299.99, 'completed'),
              (1, 5, 2, 99.98, 'completed'),
              (2, 2, 1, 899.99, 'pending'),
              (3, 3, 1, 299.99, 'processing'),
              (4, 4, 1, 79.99, 'completed');
          EOF

          echo "Verifying database setup..."
          
          # Verify PostgreSQL setup
          PG_COUNT=$(PGPASSWORD=testpass psql -h localhost -p 5433 -U testuser -d testdb -t -c "SELECT COUNT(*) FROM users;" | xargs)
          if [ "$PG_COUNT" -eq 4 ]; then
            echo "✅ PostgreSQL setup verified: $PG_COUNT users"
          else
            echo "❌ PostgreSQL setup failed: expected 4 users, got $PG_COUNT"
            exit 1
          fi
          
          # Verify MySQL setup  
          MYSQL_COUNT=$(mysql -h localhost -P 3307 -u testuser -ptestpass testdb -sN -e "SELECT COUNT(*) FROM users;")
          if [ "$MYSQL_COUNT" -eq 4 ]; then
            echo "✅ MySQL setup verified: $MYSQL_COUNT users"
          else
            echo "❌ MySQL setup failed: expected 4 users, got $MYSQL_COUNT"
            exit 1
          fi
          
          echo "✅ Both databases initialized successfully!"

      - name: Install Temporal CLI
        run: |
          echo "Downloading Temporal CLI..."
          curl -sSf https://temporal.download/cli.sh | sh || { echo "Failed to download Temporal CLI"; exit 1; }

          # The installation script places the binary at ~/.temporalio/bin/temporal
          TEMPORAL_PATH="$HOME/.temporalio/bin/temporal"
          if [ -f "$TEMPORAL_PATH" ]; then
            echo "Temporal CLI downloaded successfully to $TEMPORAL_PATH"
            chmod +x "$TEMPORAL_PATH"
            sudo cp "$TEMPORAL_PATH" /usr/local/bin/
          else
            echo "Error: 'temporal' binary not found at expected location: $TEMPORAL_PATH"
            echo "Looking for temporal files in home directory:"
            find "$HOME" -name "*temporal*" -type f 2>/dev/null || echo "No temporal files found"
            exit 1
          fi

          # Verify installation
          temporal --version

      - name: Build and install Rocketship CLI
        run: |
          make install

      - name: Warm up test server
        run: |
          echo "Warming up test server at tryme.rocketship.sh..."

          # Make initial request to wake up the server
          echo "Making initial request to wake up server..."
          curl -s https://tryme.rocketship.sh/ || echo "Initial request completed (expected to fail)"

          # Wait for server to be ready with retries
          echo "Waiting for server to be ready..."
          max_attempts=10
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts..."
            
            # Test a simple endpoint that should return 200
            if curl -s -f https://tryme.rocketship.sh/users > /dev/null 2>&1; then
              echo "✅ Test server is ready!"
              break
            fi
            
            if [ $attempt -eq $max_attempts ]; then
              echo "❌ Test server failed to respond after $max_attempts attempts"
              exit 1
            fi
            
            echo "Server not ready yet, waiting 3 seconds..."
            sleep 3
            attempt=$((attempt + 1))
          done

      - name: Test CLI commands
        run: |
          echo "Testing CLI help and version commands..."
          rocketship --help
          rocketship version

          echo "Testing validate command..."
          rocketship validate examples/
          rocketship validate examples/simple-http/rocketship.yaml

          echo "Testing individual example files..."
          echo "Running simple-delay example..."
          OUTPUT=$(rocketship run -af examples/simple-delay/rocketship.yaml)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "✗ Failed Tests: 0"; then
            echo "✅ simple-delay tests passed"
          else
            echo "❌ simple-delay tests had failures"
            exit 1
          fi

          echo "Running simple-http example..."
          OUTPUT=$(rocketship run -af examples/simple-http/rocketship.yaml)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "✗ Failed Tests: 0"; then
            echo "✅ simple-http tests passed"
          else
            echo "❌ simple-http tests had failures"
            exit 1
          fi

          echo "Running SQL testing example..."
          OUTPUT=$(rocketship run -af examples/sql-testing/rocketship.yaml)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "✗ Failed Tests: 0"; then
            echo "✅ SQL tests passed"
          else
            echo "❌ SQL tests had failures"
            exit 1
          fi

          echo "Testing all examples directory..."
          OUTPUT=$(rocketship run -ad examples)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "✗ Failed Tests: 0"; then
            echo "✅ All example tests passed"
          else
            echo "❌ Some example tests failed - this indicates a regression"
            exit 1
          fi

          echo "Testing start/stop commands..."
          rocketship start server --local --background &
          sleep 5
          rocketship stop server

      - name: Test CLI error handling
        run: |
          echo "Testing error scenarios..."
          ! rocketship validate nonexistent.yaml
          ! rocketship run -f nonexistent.yaml
          ! rocketship validate examples/simple-http/rocketship.yaml examples/nonexistent.yaml
