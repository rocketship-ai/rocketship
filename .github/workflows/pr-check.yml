name: Pull Request Check

on:
  pull_request:
    branches: ["main"]
    paths:
      - "**.go"
      - "go.mod"
      - "go.sum"
      - ".github/workflows/**"

jobs:
  test-build:
    name: Test Multi-Platform Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          check-latest: true

      - name: Run tests
        run: go test ./...

      - name: Test build for all platforms
        run: |
          # Create test build directory
          mkdir -p test-build

          # Test CLI builds
          GOOS=darwin GOARCH=amd64 go build -o test-build/rocketship-darwin-amd64 cmd/rocketship/main.go
          GOOS=darwin GOARCH=arm64 go build -o test-build/rocketship-darwin-arm64 cmd/rocketship/main.go
          GOOS=linux GOARCH=amd64 go build -o test-build/rocketship-linux-amd64 cmd/rocketship/main.go
          GOOS=linux GOARCH=arm64 go build -o test-build/rocketship-linux-arm64 cmd/rocketship/main.go
          GOOS=windows GOARCH=amd64 go build -o test-build/rocketship-windows-amd64.exe cmd/rocketship/main.go

          # Test worker builds
          GOOS=darwin GOARCH=amd64 go build -o test-build/worker-darwin-amd64 cmd/worker/main.go
          GOOS=darwin GOARCH=arm64 go build -o test-build/worker-darwin-arm64 cmd/worker/main.go
          GOOS=linux GOARCH=amd64 go build -o test-build/worker-linux-amd64 cmd/worker/main.go
          GOOS=linux GOARCH=arm64 go build -o test-build/worker-linux-arm64 cmd/worker/main.go
          GOOS=windows GOARCH=amd64 go build -o test-build/worker-windows-amd64.exe cmd/worker/main.go

          # Test engine builds
          GOOS=darwin GOARCH=amd64 go build -o test-build/engine-darwin-amd64 cmd/engine/main.go
          GOOS=darwin GOARCH=arm64 go build -o test-build/engine-darwin-arm64 cmd/engine/main.go
          GOOS=linux GOARCH=amd64 go build -o test-build/engine-linux-amd64 cmd/engine/main.go
          GOOS=linux GOARCH=arm64 go build -o test-build/engine-linux-arm64 cmd/engine/main.go
          GOOS=windows GOARCH=amd64 go build -o test-build/engine-windows-amd64.exe cmd/engine/main.go

      - name: Test Docker build
        run: docker build -f .docker/Dockerfile.cli -t test-image .

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          check-latest: true

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
