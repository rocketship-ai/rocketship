name: "Browser Testing Suite"
description: "Comprehensive browser testing with playwright (deterministic) and browser_use (agentic)"

tests:
  # Test 1: Combines basic integration + variable passing (uses browser_use 2x sequentially)
  - name: "Integration and variable passing"
    steps:
      # Browser auto-starts before first browser step!
      - name: "playwright: navigate to example.com"
        plugin: playwright
        config:
          role: script
          language: python
          headless: true
          script: |
            from playwright.sync_api import expect

            page.goto("https://example.com")
            expect(page).to_have_url("https://example.com/")

            title = page.title()
            heading = page.locator("h1").first.inner_text()

            result = {"title": title, "heading": heading}
        assertions:
          - type: "json_path"
            path: ".title"
            expected: "Example Domain"
          - type: "json_path"
            path: ".heading"
            expected: "Example Domain"

      - name: "browser_use: verify basic integration"
        plugin: browser_use
        config:
          task: |
            You are on example.com. Verify that the main heading says "Example Domain".
            If you see this heading, report success.
          max_steps: 3
          use_vision: true
          timeout: "1m"
          llm:
            provider: "openai"
            model: "gpt-4o"
            config:
              OPENAI_API_KEY: "{{ .env.OPENAI_API_KEY }}"

      - name: "playwright: navigate to IANA and save variables"
        plugin: playwright
        config:
          role: script
          language: python
          script: |
            from playwright.sync_api import expect

            page.goto("https://www.iana.org/")
            expect(page).to_have_url("https://www.iana.org/")

            page_title = page.title()
            page_url = page.url

            result = {
              "page_url": page_url,
              "page_title": page_title
            }
        save:
          - json_path: ".page_url"
            as: "saved_url"
          - json_path: ".page_title"
            as: "saved_title"

      - name: "browser_use: verify variable passing"
        plugin: browser_use
        config:
          task: |
            You are on the IANA website ({{ saved_url }}). Simply verify that you see
            the main heading "Internet Assigned Numbers Authority" on the page.
          max_steps: 2
          use_vision: true
          llm:
            provider: "openai"
            model: "gpt-4o"
            config:
              OPENAI_API_KEY: "{{ .env.OPENAI_API_KEY }}"

      - name: "playwright: verify all variables saved correctly"
        plugin: playwright
        config:
          role: script
          language: python
          script: |
            from playwright.sync_api import expect

            # Verify variables were saved correctly
            assert "{{ saved_url }}" == "https://www.iana.org/", f"URL mismatch: {{ saved_url }}"
            assert "Internet Assigned Numbers Authority" in "{{ saved_title }}", f"Title mismatch: {{ saved_title }}"

            # Verify we're still on IANA
            expect(page).to_have_url("https://www.iana.org/")

            result = {"integration_tests": "passed", "variable_passing": "success"}

  # Test 2: Timeout configuration (uses browser_use 1x)
  - name: "Timeout configuration"
    steps:
      # Browser auto-starts with headless=true (default)
      - name: "playwright: navigate to test page"
        plugin: playwright
        config:
          role: script
          language: python
          script: |
            page.goto("https://example.org")
            result = {"page": "loaded"}

      - name: "browser_use: task with explicit 2m timeout"
        plugin: browser_use
        config:
          timeout: "2m"
          task: "Verify the page loaded successfully and has content."
          max_steps: 2
          use_vision: true
          llm:
            provider: "openai"
            model: "gpt-4o"
            config:
              OPENAI_API_KEY: "{{ .env.OPENAI_API_KEY }}"

      - name: "playwright: verify timeout worked correctly"
        plugin: playwright
        config:
          role: script
          language: python
          script: |
            from playwright.sync_api import expect

            # If we got here, the timeout worked correctly
            expect(page).to_have_url("https://example.org/")
            result = {"timeout_test": "passed"}

  # Test 3: Default viewport - PURE PLAYWRIGHT
  - name: "Default viewport test"
    steps:
      - name: "playwright: verify default viewport"
        plugin: playwright
        config:
          role: script
          language: python
          headless: true
          script: |
            from playwright.sync_api import expect

            page.goto("https://example.com")
            expect(page).to_have_url("https://example.com/")

            # Verify default viewport dimensions
            width = page.evaluate("window.innerWidth")
            height = page.evaluate("window.innerHeight")

            # Default viewport is 1280x720 in headless mode
            assert width == 1280, f"Width should be 1280 (default), got {width}"
            assert height >= 500, f"Height should be at least 500, got {height}"

            result = {"viewport": "default", "width": width, "height": height}
