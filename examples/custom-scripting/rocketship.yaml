name: "Custom Scripting Demo"
version: "v1.0.0"
vars:
  api_url: "https://httpbin.org"
  max_retries: 3
  user_name: "test_user"

tests:
  - name: "Data Processing Pipeline"
    steps:
      - name: "Fetch User Data"
        plugin: "http"
        config:
          method: "GET"
          url: "{{ .vars.api_url }}/json"
        save:
          - json_path: ".slideshow.author"
            as: "author"
          - json_path: ".slideshow.title"
            as: "slideshow_title"

      - name: "Debug Script Step"
        plugin: "script"
        config:
          language: "javascript"
          script: |
            // Debug: Log all available data
            console.log("=== DEBUG: Script execution started ===");
            
            // Check what vars are available
            console.log("Available vars keys:", Object.keys(vars || {}));
            if (vars.api_url) console.log("vars.api_url:", vars.api_url);
            if (vars.user_name) console.log("vars.user_name:", vars.user_name);
            if (vars.max_retries) console.log("vars.max_retries:", vars.max_retries);
            
            // Check what state is available
            console.log("Available state keys:", Object.keys(state || {}));
            if (state.author) console.log("state.author:", state.author);
            if (state.slideshow_title) console.log("state.slideshow_title:", state.slideshow_title);
            
            // Test save function
            save("debug_test", "Script is working!");
            
            // Only assert if we have the expected data
            if (!vars.api_url) {
              assert(false, "vars.api_url is missing");
            }
            if (!vars.user_name) {
              assert(false, "vars.user_name is missing");
            }
            
            console.log("=== DEBUG: Script execution completed ===");

      - name: "Final HTTP Request"
        plugin: "http"
        config:
          method: "GET"
          url: "{{ .vars.api_url }}/delay/1"
        assertions:
          - type: "status_code"
            expected: 200